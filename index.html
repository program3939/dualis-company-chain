<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual-Coin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            border: none;
            background: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #218838;
        }
        .leaderboard {
            margin-top: 30px;
        }
        .transaction-status {
            color: orange;
        }
        .admin-panel {
            display: none;
            margin-top: 20px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dual-Coin</h1>

        <div id="user-form" class="form-group">
            <h2>Benutzerregistrierung</h2>
            <label for="discordName">Discord-Name:</label>
            <input type="text" id="discordName" required>
            <label for="pin">PIN (max. 8 Zeichen):</label>
            <input type="text" id="pin" maxlength="8" required>
            <button onclick="registerUser()">Registrieren</button>
        </div>

        <div id="transaction-form" class="form-group">
            <h2>Coins Überweisen</h2>
            <label for="from">Von (Discord-Name):</label>
            <input type="text" id="fromUser" required>
            <label for="to">An (Discord-Name):</label>
            <input type="text" id="toUser" required>
            <label for="amount">Betrag:</label>
            <input type="number" id="amount" required>
            <button onclick="transferCoins()">Überweisen</button>
            <p id="transactionStatus" class="transaction-status"></p>
        </div>

        <div id="leaderboard" class="leaderboard">
            <h2>Leaderboard</h2>
            <ul id="userList"></ul>
        </div>

        <div class="admin-panel" id="admin-panel">
            <h2>Admin-Bereich</h2>
            <label for="adminUser">Benutzername:</label>
            <input type="text" id="adminUser">
            <label for="adminPass">Passwort:</label>
            <input type="password" id="adminPass">
            <button onclick="adminLogin()">Einloggen</button>
            <h3>Überweisungen Bestätigen</h3>
            <ul id="pendingTransactions"></ul>
        </div>
    </div>

    <script>
        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyDGHc-MC0XZkZBPdhypCHoqmqTmHhhK5Ig",
            authDomain: "dualis-company-chain.firebaseapp.com",
            databaseURL: "https://dualis-company-chain-default-rtdb.firebaseio.com",
            projectId: "dualis-company-chain",
            storageBucket: "dualis-company-chain.appspot.com",
            messagingSenderId: "521000433736",
            appId: "1:521000433736:web:c5c60acd15c0d1b5f6c07d",
            measurementId: "G-JEYQSXL8Z9"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Benutzerregistrierung
        function registerUser() {
            const discordName = document.getElementById("discordName").value;
            const pin = document.getElementById("pin").value;

            if (discordName && pin) {
                const userId = discordName + "_" + Date.now();
                database.ref('users/' + userId).set({
                    discordName: discordName,
                    pin: pin,
                    coins: 0
                }).then(() => {
                    alert("Benutzer erfolgreich registriert!");
                    document.getElementById("discordName").value = '';
                    document.getElementById("pin").value = '';
                    updateLeaderboard();
                });
            }
        }

        // Coins überweisen
        function transferCoins() {
            const fromUser = document.getElementById("fromUser").value;
            const toUser = document.getElementById("toUser").value;
            const amount = parseInt(document.getElementById("amount").value);

            if (fromUser && toUser && amount) {
                database.ref('transactions/').push({
                    fromUser: fromUser,
                    toUser: toUser,
                    amount: amount,
                    status: 'pending'
                }).then(() => {
                    document.getElementById("transactionStatus").innerText = "In Bearbeitung...";
                    setTimeout(() => {
                        document.getElementById("transactionStatus").innerText = "Überweisung abgeschlossen!";
                        updateLeaderboard();
                    }, 3000); // Simuliere Bestätigung nach 3 Sekunden
                });
            }
        }

        // Leaderboard aktualisieren
        function updateLeaderboard() {
            const userList = document.getElementById("userList");
            userList.innerHTML = '';

            database.ref('users/').once('value', (snapshot) => {
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const li = document.createElement("li");
                    li.textContent = `${user.discordName}: ${user.coins} Coins`;
                    userList.appendChild(li);
                });
            });
        }

        // Admin-Login
        function adminLogin() {
            const username = document.getElementById("adminUser").value;
            const password = document.getElementById("adminPass").value;

            if (username === 'Dualis' && password === '28102006') {
                document.getElementById("admin-panel").style.display = 'block';
                fetchPendingTransactions();
            } else {
                alert("Ungültige Anmeldedaten");
            }
        }

        // Überweisungen abrufen
        function fetchPendingTransactions() {
            const pendingTransactionsList = document.getElementById("pendingTransactions");
            pendingTransactionsList.innerHTML = '';

            database.ref('transactions/').orderByChild('status').equalTo('pending').once('value', (snapshot) => {
                snapshot.forEach(childSnapshot => {
                    const transaction = childSnapshot.val();
                    const li = document.createElement("li");
                    li.textContent = `Von: ${transaction.fromUser}, An: ${transaction.toUser}, Betrag: ${transaction.amount}`;
                    const confirmButton = document.createElement("button");
                    confirmButton.innerText = "Bestätigen";
                    confirmButton.onclick = () => confirmTransaction(childSnapshot.key);
                    li.appendChild(confirmButton);
                    pendingTransactionsList.appendChild(li);
                });
            });
        }

        // Überweisung bestätigen
        function confirmTransaction(transactionId) {
            database.ref('transactions/' + transactionId).once('value').then(snapshot => {
                const transaction = snapshot.val();
                const fromUserRef = database.ref('users').orderByChild('discordName').equalTo(transaction.fromUser);
                const toUserRef = database.ref('users').orderByChild('discordName').equalTo(transaction.toUser);

                fromUserRef.once('child_added').then(fromUserSnapshot => {
                    const fromUserData = fromUserSnapshot.val();
                    const newCoinBalance = fromUserData.coins - transaction.amount;

                    if (newCoinBalance >= 0) {
                        // Update sender's coin balance
                        fromUserSnapshot.ref.update({ coins: newCoinBalance });

                        toUserRef.once('child_added').then(toUserSnapshot => {
                            const toUserData = toUserSnapshot.val();
                            const newCoins = toUserData.coins + transaction.amount;

                            // Update receiver's coin balance
                            toUserSnapshot.ref.update({ coins: newCoins });

                            // Update transaction status
                            snapshot.ref.update({ status: 'completed' });
                            alert("Überweisung bestätigt!");
                            fetchPendingTransactions();
                            updateLeaderboard();
                        });
                    } else {
                        alert("Nicht genügend Coins!");
                    }
                });
            });
        }
    </script>
</body>
</html>
