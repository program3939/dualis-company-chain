<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual-Coin Platform</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 0;
            text-align: center;
        }
        .container {
            width: 80%;
            margin: 20px auto;
        }
        h1, h2, h3 {
            text-align: center;
        }
        .machine, .leaderboard, .admin-panel {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<header>
    <h1>Dual-Coin Platform</h1>
</header>

<div class="container">
    <!-- Interaktiver Automat -->
    <section class="machine">
        <h2>Interaktiver Automat</h2>
        <p>Aktueller Coin-Preis: <span id="coin-price">Laden...</span></p>
        <form id="code-form">
            <input type="text" id="discord-name" placeholder="Discord Name" required>
            <input type="text" id="code" placeholder="Code" required>
            <button type="submit">Einreichen</button>
        </form>
        <p id="message"></p>
    </section>

    <!-- Leaderboard -->
    <section class="leaderboard">
        <h2>Leaderboard</h2>
        <table>
            <thead>
                <tr>
                    <th>Discord Name</th>
                    <th>Coins</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <!-- Data will be inserted here -->
            </tbody>
        </table>
    </section>

    <!-- Admin Panel -->
    <section class="admin-panel">
        <h2>Admin Login</h2>
        <form id="admin-login-form">
            <input type="text" id="username" placeholder="Benutzername">
            <input type="password" id="password" placeholder="Passwort">
            <button type="button" onclick="adminLogin()">Login</button>
        </form>
        <div id="admin-section" style="display:none;">
            <h3>Admin Panel</h3>
            <p>Coin Preis ändern:</p>
            <input type="number" id="coinPrice" placeholder="Neuer Coin-Preis">
            <button onclick="updateCoinPrice()">Preis ändern</button>
            <p id="admin-message"></p>

            <h3>Neuen Code generieren</h3>
            <input type="text" id="newCode" placeholder="Custom Code (Optional)">
            <input type="number" id="coinValue" placeholder="Coin Wert">
            <input type="checkbox" id="multiUse"> Mehrfach verwendbar
            <button onclick="generateNewCode()">Code generieren</button>
            <p id="code-message"></p>

            <h3>Aktive Codes verwalten</h3>
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Coin Wert</th>
                        <th>Status</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="codes-body">
                    <!-- Active codes will be inserted here -->
                </tbody>
            </table>
        </div>
    </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
<script>
// Firebase-Konfiguration
const firebaseConfig = {
    apiKey: "AIzaSyDGHc-MC0XZkZBPdhypCHoqmqTmHhhK5Ig",
    authDomain: "dualis-company-chain.firebaseapp.com",
    databaseURL: "https://dualis-company-chain-default-rtdb.firebaseio.com",
    projectId: "dualis-company-chain",
    storageBucket: "dualis-company-chain.appspot.com",
    messagingSenderId: "521000433736",
    appId: "1:521000433736:web:c5c60acd15c0d1b5f6c07d",
    measurementId: "G-JEYQSXL8Z9"
};

// Firebase initialisieren
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Preiserhöhung um 2% nach Code-Einlösung
function increaseCoinPriceBy2Percent() {
    firebase.database().ref('coinPrice').get().then((snapshot) => {
        let currentPrice = snapshot.val();
        let newPrice = currentPrice * 1.02; // Erhöhung um 2%
        firebase.database().ref('coinPrice').set(newPrice);
        document.getElementById('coin-price').textContent = "$" + newPrice.toFixed(2);
    });
}

// Datum der letzten Aktivität aktualisieren
function updateLastActivityDate() {
    const currentDate = new Date().toISOString();
    firebase.database().ref('lastActivity').set(currentDate);
}

// Preissenkung um 5% nach einer Woche Inaktivität
function checkForWeeklyPriceDrop() {
    firebase.database().ref('lastActivity').get().then((snapshot) => {
        const lastActivityDate = new Date(snapshot.val());
        const currentDate = new Date();
        const timeDifference = currentDate - lastActivityDate;
        const daysDifference = timeDifference / (1000 * 60 * 60 * 24); // Unterschied in Tagen

        if (daysDifference >= 7) {
            // Preissenkung um 5%
            firebase.database().ref('coinPrice').get().then((priceSnapshot) => {
                let currentPrice = priceSnapshot.val();
                let newPrice = currentPrice * 0.95; // Senkung um 5%
                firebase.database().ref('coinPrice').set(newPrice);
                document.getElementById('coin-price').textContent = "$" + newPrice.toFixed(2);
            });
        }
    });
}

// Code-Einreichung
document.getElementById('code-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const discordName = document.getElementById('discord-name').value;
    const code = document.getElementById('code').value;
    const messageEl = document.getElementById('message');

    // Code-Validierung
    firebase.database().ref('codes/' + code).get().then((snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            if (data.multiUse || !data.redeemed) {
                // Coin zum Benutzer hinzufügen
                firebase.database().ref('users/' + discordName).get().then((userSnapshot) => {
                    let coins = 0;
                    if (userSnapshot.exists()) {
                        coins = userSnapshot.val().coins;
                    }
                    coins += data.value;
                    firebase.database().ref('users/' + discordName).set({ coins });
                    messageEl.textContent = "Code erfolgreich eingelöst!";
                    messageEl.className = "success";

                    // Wenn der Code nur einmal verwendet werden darf, als eingelöst markieren
                    if (!data.multiUse) {
                        firebase.database().ref('codes/' + code).update({ redeemed: true });
                    }

                    // Preiserhöhung um 2% und Datum der letzten Aktivität aktualisieren
                    increaseCoinPriceBy2Percent();
                    updateLastActivityDate();
                });
            } else {
                messageEl.textContent = "Code wurde bereits eingelöst!";
                messageEl.className = "error";
            }
        } else {
            messageEl.textContent = "Ungültiger Code!";
            messageEl.className = "error";
        }
    });
});

// Seite laden und die wöchentliche Preissenkung prüfen
document.addEventListener('DOMContentLoaded', function() {
    // Überprüfe, ob seit der letzten Aktivität eine Woche vergangen ist
    checkForWeeklyPriceDrop();
    
    // Coin-Preis aktualisieren
    firebase.database().ref('coinPrice').get().then((snapshot) => {
        const coinPrice = snapshot.val();
        document.getElementById('coin-price').textContent = "$" + coinPrice.toFixed(2);
    });
});
</script>
</body>
</html>
